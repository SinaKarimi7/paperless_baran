/**
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * This software consists of voluntary contributions made by many individuals
 * and is licensed under the new BSD license.
 *
 * @author      David Zeller <me@zellerda.com>
 * @license     http://www.opensource.org/licenses/BSD-3-Clause New BSD license
 * @version     2.4.1
 */
!function(a){var c={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,ARROW_UP:38,ARROW_DOWN:40,COMMA:188},d=null,e="tokenize";a.tokenize=function(b){void 0==b&&(b=a.fn.tokenize.defaults),this.options=b},a.extend(a.tokenize.prototype,{init:function(b){var c=this;this.select=b.attr("multiple","multiple").css({margin:0,padding:0,border:0}).hide(),this.container=a("<div />").attr("class",this.select.attr("class")).addClass("Tokenize"),1==this.options.maxElements&&this.container.addClass("OnlyOne"),this.dropdown=a("<ul />").addClass("Dropdown"),this.tokensContainer=a("<ul />").addClass("TokensContainer"),this.searchToken=a("<li />").addClass("TokenSearch").appendTo(this.tokensContainer),this.searchInput=a("<input />").appendTo(this.searchToken),this.options.searchMaxLength>0&&this.searchInput.attr("maxlength",this.options.searchMaxLength),this.select.prop("disabled")&&this.disable(),this.options.sortable&&("undefined"!=typeof a.ui?this.tokensContainer.sortable({items:"li.Token",cursor:"move",placeholder:"Token MovingShadow",forcePlaceholderSize:!0,update:function(){c.updateOrder()},start:function(){c.searchToken.hide()},stop:function(){c.searchToken.show()}}).disableSelection():(this.options.sortable=!1,console.log("jQuery UI is not loaded, sortable option has been disabled"))),this.container.append(this.tokensContainer).append(this.dropdown).insertAfter(this.select),this.tokensContainer.on("click",function(a){a.stopImmediatePropagation(),c.searchInput.get(0).focus(),c.updatePlaceholder(),c.dropdown.is(":hidden")&&""!=c.searchInput.val()&&c.search()}),this.searchInput.on("focus click",function(){c.options.displayDropdownOnFocus&&"select"==c.options.datas&&c.search()}),this.searchInput.on("keydown",function(a){c.resizeSearchInput(),c.keydown(a)}),this.searchInput.on("keyup",function(a){c.keyup(a)}),this.searchInput.on("paste",function(){setTimeout(function(){c.resizeSearchInput()},10),setTimeout(function(){var b=c.searchInput.val().split(",");b.length>1&&a.each(b,function(a,b){c.tokenAdd(b.trim(),"")})},20)}),a(document).on("click",function(){c.dropdownHide(),1==c.options.maxElements&&c.searchInput.val()&&c.tokenAdd(c.searchInput.val(),"")}),this.resizeSearchInput(),a("option:selected",this.select).each(function(){c.tokenAdd(a(this).attr("value"),a(this).html(),!0)}),this.updatePlaceholder()},updateOrder:function(){var b,c,d=this;a.each(this.tokensContainer.sortable("toArray",{attribute:"data-value"}),function(e,f){c=a('option[value="'+f+'"]',d.select),void 0==b?c.prependTo(d.select):b.after(c),b=c}),this.options.onReorder(this)},updatePlaceholder:function(){0!=this.options.placeholder&&(void 0==this.placeholder&&(this.placeholder=a("<li />").addClass("Placeholder").html(this.options.placeholder),this.placeholder.insertBefore(a("li:first-child",this.tokensContainer))),0==this.searchInput.val().length&&0==a("li.Token",this.tokensContainer).length?this.placeholder.show():this.placeholder.hide())},dropdownShow:function(){this.dropdown.show()},dropdownPrev:function(){a("li.Hover",this.dropdown).length>0?a("li.Hover",this.dropdown).is("li:first-child")?(a("li.Hover",this.dropdown).removeClass("Hover"),a("li:last-child",this.dropdown).addClass("Hover")):a("li.Hover",this.dropdown).removeClass("Hover").prev().addClass("Hover"):a("li:first",this.dropdown).addClass("Hover")},dropdownNext:function(){a("li.Hover",this.dropdown).length>0?a("li.Hover",this.dropdown).is("li:last-child")?(a("li.Hover",this.dropdown).removeClass("Hover"),a("li:first-child",this.dropdown).addClass("Hover")):a("li.Hover",this.dropdown).removeClass("Hover").next().addClass("Hover"):a("li:first",this.dropdown).addClass("Hover")},dropdownAddItem:function(b,c,d){if(void 0==d&&(d=c),a('li[data-value="'+b+'"]',this.tokensContainer).length)return!1;var e=this,f=a("<li />").attr("data-value",b).attr("data-text",c).html(d).on("click",function(b){b.stopImmediatePropagation(),e.tokenAdd(a(this).attr("data-value"),a(this).attr("data-text"))}).on("mouseover",function(){a(this).addClass("Hover")}).on("mouseout",function(){a("li",e.dropdown).removeClass("Hover")});return this.dropdown.append(f),this.options.onDropdownAddItem(b,c,d,this),!0},dropdownHide:function(){this.dropdownReset(),this.dropdown.hide()},dropdownReset:function(){this.dropdown.html("")},resizeSearchInput:function(){this.searchInput.attr("size",this.searchInput.val().length>1?this.searchInput.val().length:5),this.updatePlaceholder()},resetSearchInput:function(){this.searchInput.val(""),this.resizeSearchInput()},resetPendingTokens:function(){a("li.PendingDelete",this.tokensContainer).removeClass("PendingDelete")},keydown:function(b){if(b.keyCode==c.COMMA)b.preventDefault(),this.tokenAdd(this.searchInput.val(),"");else switch(b.keyCode){case c.BACKSPACE:0==this.searchInput.val().length&&(b.preventDefault(),a("li.Token.PendingDelete",this.tokensContainer).length?this.tokenRemove(a("li.Token.PendingDelete").attr("data-value")):a("li.Token:last",this.tokensContainer).addClass("PendingDelete"),this.dropdownHide());break;case c.TAB:case c.ENTER:if(a("li.Hover",this.dropdown).length){var d=a("li.Hover",this.dropdown);b.preventDefault(),this.tokenAdd(d.attr("data-value"),d.attr("data-text"))}else this.searchInput.val()&&(b.preventDefault(),this.tokenAdd(this.searchInput.val(),""));this.resetPendingTokens();break;case c.ESCAPE:this.resetSearchInput(),this.dropdownHide(),this.resetPendingTokens();break;case c.ARROW_UP:b.preventDefault(),this.dropdownPrev();break;case c.ARROW_DOWN:b.preventDefault(),this.dropdownNext();break;default:this.resetPendingTokens()}},keyup:function(a){switch(this.updatePlaceholder(),a.keyCode){case c.TAB:case c.ENTER:case c.ESCAPE:case c.ARROW_UP:case c.ARROW_DOWN:break;case c.BACKSPACE:this.searchInput.val()?this.search():this.dropdownHide();break;default:this.searchInput.val()&&this.search()}},search:function(){var b=this,c=1;if(this.options.maxElements>0&&a("li.Token",this.tokensContainer).length>=this.options.maxElements)return!1;if("select"==this.options.datas){var d=!1,e=new RegExp(this.searchInput.val().replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");this.dropdownReset(),a("option",this.select).not(":selected").each(function(){return c<=b.options.nbDropdownElements?void(e.test(a(this).html())&&(b.dropdownAddItem(a(this).attr("value"),a(this).html()),d=!0,c++)):!1}),d?(a("li:first",this.dropdown).addClass("Hover"),this.dropdownShow()):this.dropdownHide()}else this.debounce(function(){a.ajax({url:b.options.datas,data:b.options.searchParam+"="+b.searchInput.val(),dataType:b.options.dataType,success:function(d){return d&&(b.dropdownReset(),a.each(d,function(a,d){if(!(c<=b.options.nbDropdownElements))return!1;var e=void 0;d[b.options.htmlField]&&(e=d[b.options.htmlField]),b.dropdownAddItem(d[b.options.valueField],d[b.options.textField],e),c++}),a("li",b.dropdown).length)?(a("li:first",b.dropdown).addClass("Hover"),b.dropdownShow(),!0):void b.dropdownHide()},error:function(a,b){console.log("Error : "+b)}})},this.options.debounce)},debounce:function(a,b){var c=this,e=arguments,f=function(){a.apply(c,e),d=null};d&&clearTimeout(d),d=setTimeout(f,b||this.options.debounce)},tokenAdd:function(b,c,d){if(b=this.escape(b),void 0==b||""==b)return!1;if((void 0==c||""==c)&&(c=b),void 0==d&&(d=!1),this.options.maxElements>0&&a("li.Token",this.tokensContainer).length>=this.options.maxElements)return this.resetSearchInput(),!1;var e=this,f=a("<a />").addClass("Close").html("&#215;").on("click",function(a){a.stopImmediatePropagation(),e.tokenRemove(b)});if(a('option[value="'+b+'"]',this.select).length)a('option[value="'+b+'"]',this.select).attr("selected","selected");else{if(!(this.options.newElements||!this.options.newElements&&a('li[data-value="'+b+'"]',this.dropdown).length>0))return this.resetSearchInput(),!1;var g=a("<option />").attr("selected","selected").attr("value",b).attr("data-type","custom").html(c);this.select.append(g)}return a('li.Token[data-value="'+b+'"]',this.tokensContainer).length>0?!1:(a("<li />").addClass("Token").attr("data-value",b).append("<span>"+c+"</span>").prepend(f).insertBefore(this.searchToken),d||this.options.onAddToken(b,c,this),this.resetSearchInput(),this.dropdownHide(),!0)},tokenRemove:function(b){var c=a('option[value="'+b+'"]',this.select);"custom"==c.attr("data-type")?c.remove():c.removeAttr("selected"),a('li.Token[data-value="'+b+'"]',this.tokensContainer).remove(),this.options.onRemoveToken(b,this),this.resizeSearchInput(),this.dropdownHide()},clear:function(){var b=this;a("li.Token",this.tokensContainer).each(function(){b.tokenRemove(a(this).attr("data-value"))}),this.options.onClear(this)},disable:function(){this.select.prop("disabled",!0),this.searchInput.prop("disabled",!0),this.container.addClass("Disabled"),this.options.sortable&&this.tokensContainer.sortable("disable")},enable:function(){this.select.prop("disabled",!1),this.searchInput.prop("disabled",!1),this.container.removeClass("Disabled"),this.options.sortable&&this.tokensContainer.sortable("enable")},escape:function(a){return String(a).replace(/["]/g,function(){return""})}}),a.fn.tokenize=function(b){return void 0==b&&(b={}),this.each(function(){var c=new a.tokenize(a.extend({},a.fn.tokenize.defaults,b));c.init(a(this)),a(this).data(e,c)}),this},a.fn.tokenize.defaults={datas:"select",placeholder:!1,searchParam:"search",searchMaxLength:0,debounce:0,newElements:!0,nbDropdownElements:10,displayDropdownOnFocus:!1,maxElements:0,sortable:!1,dataType:"json",valueField:"value",textField:"text",htmlField:"html",onAddToken:function(){},onRemoveToken:function(){},onClear:function(){},onReorder:function(){},onDropdownAddItem:function(){}}}(jQuery,"tokenize");
